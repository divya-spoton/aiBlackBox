<!-- frontend/index.html -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Prompt → App (UI)</title>
    <style>
        body {
            font-family: system-ui;
            padding: 18px;
            max-width: 900px;
            margin: auto
        }

        textarea {
            width: 100%;
            height: 120px
        }

        input,
        button {
            padding: 8px;
            margin: 6px 0
        }

        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin-top: 10px
        }

        pre {
            background: #f6f6f6;
            padding: 10px;
            overflow: auto
        }
    </style>
</head>

<body>
    <h1>Prompt → App</h1>
    <label>Prompt:</label>
    <textarea
        id="prompt">Create a modern single-page TODO app. Use vanilla HTML/CSS/JS. Save tasks in localStorage.</textarea>
    <br />
    <button id="create">Create Project</button>
    <div id="statusBox" style="display:none">
        <p><strong>Project ID:</strong> <span id="projectId"></span></p>
        <p><strong>Status:</strong> <span id="status"></span></p>
        <button id="stopPreview" style="display:none">Stop Preview</button>
        <h3>Logs</h3>
        <pre id="logs" style="height:200px"></pre>
        <h3>Preview</h3>
        <div id="previewArea"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';

        document.getElementById('create').onclick = async () => {
            const prompt = document.getElementById('prompt').value;
            const res = await fetch(API_BASE + '/api/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            const data = await res.json();
            const id = data.projectId;
            document.getElementById('projectId').textContent = id;
            document.getElementById('statusBox').style.display = 'block';
            pollStatus(id);
        };

        let pollInterval;
        async function pollStatus(id) {
            clearInterval(pollInterval);
            async function fetchOne() {
                const r = await fetch(API_BASE + '/api/status/' + id);
                const j = await r.json();
                document.getElementById('status').textContent = j.status + (j.iteration ? ' (iter: ' + j.iteration + ')' : '');
                document.getElementById('logs').textContent = (j.logs || []).map(l => new Date(l.timestamp).toLocaleTimeString() + '  ' + l.message).join('\\n') || '';
                if (j.deployUrl || j.previewUrl) {
                    const url = j.previewUrl || j.deployUrl;
                    document.getElementById('previewArea').innerHTML = `<iframe src="${url}"></iframe>`;
                    document.getElementById('stopPreview').style.display = 'inline-block';
                }
                if (j.status === 'completed' || j.status === 'failed') {
                    clearInterval(pollInterval);
                }
            }
            await fetchOne();
            pollInterval = setInterval(fetchOne, 2500);
        }

        document.getElementById('stopPreview').onclick = async () => {
            const id = document.getElementById('projectId').textContent;
            await fetch(API_BASE + '/api/stop-preview/' + id, { method: 'POST' });
            document.getElementById('previewArea').innerHTML = '';
            document.getElementById('stopPreview').style.display = 'none';
        };
    </script>
</body>

</html>